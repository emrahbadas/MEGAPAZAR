{
  "name": "MEGAPAZAR Main Router",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatsapp-webhook",
        "responseMode": "responseNode"
      },
      "id": "webhook-1",
      "name": "WhatsApp Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300],
      "webhookId": "megapazar-whatsapp-main"
    },
    {
      "parameters": {
        "jsCode": "// Extract WhatsApp message details\nconst body = $input.item.json.body || $input.item.json;\n\nconst from = body.From || body.from || '';\nconst messageBody = body.Body || body.body || '';\nconst mediaUrl = body.MediaUrl0 || body.mediaUrl0 || null;\nconst numMedia = parseInt(body.NumMedia || body.numMedia || 0);\n\n// Clean phone number (remove 'whatsapp:' prefix)\nconst phoneNumber = from.replace('whatsapp:', '').trim();\n\n// Determine user intent\nlet intent = 'unknown';\nconst lowerMessage = messageBody.toLowerCase().trim();\n\n// Intent classification\nif (!lowerMessage || lowerMessage === 'merhaba' || lowerMessage === 'hi' || lowerMessage === 'hello') {\n  intent = 'welcome';\n} else if (lowerMessage.includes('ilan ver') || lowerMessage.includes('satmak istiyorum') || lowerMessage.includes('satis') || lowerMessage.includes('sat')) {\n  intent = 'create_listing';\n} else if (lowerMessage.includes('ara') || lowerMessage.includes('ariyorum') || lowerMessage.includes('bul')) {\n  intent = 'search';\n} else if (lowerMessage.includes('siparis') || lowerMessage.includes('almak istiyorum') || lowerMessage.includes('satin')) {\n  intent = 'order';\n} else if (lowerMessage.includes('ilanlarim') || lowerMessage.includes('listem')) {\n  intent = 'my_listings';\n} else if (lowerMessage.includes('siparislerim')) {\n  intent = 'my_orders';\n} else if (lowerMessage.includes('yardim') || lowerMessage === 'help' || lowerMessage === '?') {\n  intent = 'help';\n} else if (numMedia > 0) {\n  intent = 'media_upload';\n} else {\n  intent = 'conversation';\n}\n\nreturn {\n  phoneNumber,\n  messageBody,\n  mediaUrl,\n  numMedia,\n  intent,\n  originalPayload: body,\n  timestamp: new Date().toISOString()\n};"
      },
      "id": "classify-intent",
      "name": "Classify Intent",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "welcome",
              "leftValue": "={{ $json.intent }}",
              "rightValue": "welcome",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "listing",
              "leftValue": "={{ $json.intent }}",
              "rightValue": "listing",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "search",
              "leftValue": "={{ $json.intent }}",
              "rightValue": "search",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "order",
              "leftValue": "={{ $json.intent }}",
              "rightValue": "order",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "help",
              "leftValue": "={{ $json.intent }}",
              "rightValue": "help",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "conversation",
              "leftValue": "={{ $json.intent }}",
              "rightValue": "conversation",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "fallbackOutput": "extra"
      },
      "id": "router",
      "name": "Route by Intent",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [650, 300]
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "ğŸ‰ *HoÅŸ geldin MEGAPAZAR'a!*\\n\\nBen senin AI asistanÄ±nÄ±m. ÅunlarÄ± yapabilirim:\\n\\nğŸ“¦ *Ä°lan Ver* - \"ilan vermek istiyorum\"\\nğŸ” *ÃœrÃ¼n Ara* - \"rotor arÄ±yorum\"\\nğŸ“‹ *Ä°lanlarÄ±m* - \"ilanlarÄ±mÄ± gÃ¶ster\"\\nğŸ“Š *SipariÅŸlerim* - \"sipariÅŸlerimi gÃ¶ster\"\\nâ“ *YardÄ±m* - \"yardÄ±m\"\\n\\nHemen baÅŸlamak iÃ§in yukarÄ±daki komutlardan birini yazabilirsin!"
      },
      "id": "welcome-message",
      "name": "Send Welcome Message",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [850, 100]
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "ğŸ“š *MEGAPAZAR YardÄ±m MenÃ¼sÃ¼*\\n\\n*Ä°lan Verme:*\\nâ€¢ \"ilan vermek istiyorum\"\\nâ€¢ \"satmak istiyorum\"\\n\\n*ÃœrÃ¼n Arama:*\\nâ€¢ \"rotor arÄ±yorum\"\\nâ€¢ \"kompresÃ¶r bul\"\\n\\n*Listeleme:*\\nâ€¢ \"ilanlarÄ±mÄ± gÃ¶ster\"\\nâ€¢ \"sipariÅŸlerimi gÃ¶ster\"\\n\\n*DiÄŸer:*\\nâ€¢ \"yardÄ±m\" - Bu menÃ¼yÃ¼ gÃ¶ster\\n\\nSorularÄ±nÄ±z iÃ§in doÄŸrudan mesaj atabilirsiniz! ğŸ’¬"
      },
      "id": "help-message",
      "name": "Send Help Menu",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [850, 200]
    },
    {
      "parameters": {
        "url": "={{ $env.BACKEND_API_URL }}/conversation",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"user_id\": \"{{ $json.phoneNumber }}\",\n  \"message\": \"{{ $json.messageBody }}\",\n  \"source\": \"whatsapp\"\n}",
        "options": {}
      },
      "id": "call-backend-conversation",
      "name": "Call Backend API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [850, 350]
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.response }}"
      },
      "id": "respond-conversation",
      "name": "Send API Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1050, 350]
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "ğŸš€ *Harika! Ä°lan vermeye baÅŸlayalÄ±m.*\\n\\nBana ÅŸunlarÄ± sÃ¶yle:\\n1ï¸âƒ£ Ne satÄ±yorsun?\\n2ï¸âƒ£ FiyatÄ± nedir?\\n3ï¸âƒ£ ÃœrÃ¼nÃ¼n durumu (yeni/ikinci el)?\\n\\nÃ–rnek: \"Rotor satÄ±yorum, 150 TL, ikinci el\""
      },
      "id": "start-listing",
      "name": "Start Listing Flow",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [850, 250]
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "ğŸ” *Ne aramak istersin?*\\n\\nÃ–rnek:\\nâ€¢ \"rotor arÄ±yorum\"\\nâ€¢ \"kompresÃ¶r 220V\"\\nâ€¢ \"500 TL'ye kadar soÄŸutma cihazÄ±\""
      },
      "id": "start-search",
      "name": "Start Search Flow",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [850, 400]
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "âŒ ÃœzgÃ¼nÃ¼m, ne demek istediÄŸini anlayamadÄ±m.\\n\\n\"yardÄ±m\" yazarak komutlarÄ± gÃ¶rebilirsin."
      },
      "id": "fallback",
      "name": "Fallback Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [850, 500]
    }
  ],
  "connections": {
    "WhatsApp Webhook": {
      "main": [
        [
          {
            "node": "Classify Intent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Classify Intent": {
      "main": [
        [
          {
            "node": "Route by Intent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route by Intent": {
      "main": [
        [
          {
            "node": "Send Welcome Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Start Listing Flow",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Start Search Flow",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [
          {
            "node": "Send Help Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Call Backend API",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fallback Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Backend API": {
      "main": [
        [
          {
            "node": "Send API Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-01-18T00:00:00.000Z",
  "versionId": "1"
}
