{
    "name": "MEGAPAZAR Main Router",
    "nodes": [
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "whatsapp-webhook",
                "responseMode": "responseNode",
                "options": {}
            },
            "id": "webhook-1",
            "name": "WhatsApp Webhook",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 1,
            "position": [
                250,
                300
            ],
            "webhookId": "megapazar-whatsapp-main"
        },
        {
            "parameters": {
                "mode": "raw",
                "jsonOutput": "={{ JSON.stringify($json) }}",
                "options": {}
            },
            "id": "parse-incoming",
            "name": "Parse Incoming Message",
            "type": "n8n-nodes-base.code",
            "typeVersion": 1,
            "position": [
                450,
                300
            ]
        },
        {
            "parameters": {
                "functionCode": "// Extract WhatsApp message details\nconst body = $input.item.json.body || $input.item.json;\n\nconst from = body.From || body.from || '';\nconst messageBody = body.Body || body.body || '';\nconst mediaUrl = body.MediaUrl0 || body.mediaUrl0 || null;\nconst numMedia = parseInt(body.NumMedia || body.numMedia || 0);\n\n// Clean phone number (remove 'whatsapp:' prefix)\nconst phoneNumber = from.replace('whatsapp:', '').trim();\n\n// Determine user intent\nlet intent = 'unknown';\nconst lowerMessage = messageBody.toLowerCase().trim();\n\n// Intent classification\nif (!lowerMessage || lowerMessage === 'merhaba' || lowerMessage === 'hi' || lowerMessage === 'hello') {\n  intent = 'welcome';\n} else if (lowerMessage.includes('ilan ver') || lowerMessage.includes('satmak istiyorum') || lowerMessage.includes('satis') || lowerMessage.includes('sat')) {\n  intent = 'create_listing';\n} else if (lowerMessage.includes('ara') || lowerMessage.includes('ariyorum') || lowerMessage.includes('bul')) {\n  intent = 'search';\n} else if (lowerMessage.includes('siparis') || lowerMessage.includes('almak istiyorum') || lowerMessage.includes('satin')) {\n  intent = 'order';\n} else if (lowerMessage.includes('ilanlarim') || lowerMessage.includes('listem')) {\n  intent = 'my_listings';\n} else if (lowerMessage.includes('siparislerim')) {\n  intent = 'my_orders';\n} else if (lowerMessage.includes('yardim') || lowerMessage === 'help' || lowerMessage === '?') {\n  intent = 'help';\n} else if (numMedia > 0) {\n  // If user sends media without text, assume listing flow\n  intent = 'media_upload';\n} else {\n  // Default: continue conversation or search\n  intent = 'conversation';\n}\n\nreturn {\n  json: {\n    phoneNumber,\n    messageBody,\n    mediaUrl,\n    numMedia,\n    intent,\n    originalPayload: body,\n    timestamp: new Date().toISOString()\n  }\n};"
            },
            "id": "classify-intent",
            "name": "Classify Intent",
            "type": "n8n-nodes-base.code",
            "typeVersion": 1,
            "position": [
                650,
                300
            ]
        },
        {
            "parameters": {
                "rules": {
                    "values": [
                        {
                            "conditions": {
                                "string": [
                                    {
                                        "value1": "={{ $json.intent }}",
                                        "value2": "welcome"
                                    }
                                ]
                            },
                            "renameOutput": true,
                            "outputKey": "welcome"
                        },
                        {
                            "conditions": {
                                "string": [
                                    {
                                        "value1": "={{ $json.intent }}",
                                        "operation": "contains",
                                        "value2": "listing"
                                    }
                                ]
                            },
                            "renameOutput": true,
                            "outputKey": "listing"
                        },
                        {
                            "conditions": {
                                "string": [
                                    {
                                        "value1": "={{ $json.intent }}",
                                        "value2": "search"
                                    }
                                ]
                            },
                            "renameOutput": true,
                            "outputKey": "search"
                        },
                        {
                            "conditions": {
                                "string": [
                                    {
                                        "value1": "={{ $json.intent }}",
                                        "value2": "order"
                                    }
                                ]
                            },
                            "renameOutput": true,
                            "outputKey": "order"
                        },
                        {
                            "conditions": {
                                "string": [
                                    {
                                        "value1": "={{ $json.intent }}",
                                        "value2": "help"
                                    }
                                ]
                            },
                            "renameOutput": true,
                            "outputKey": "help"
                        },
                        {
                            "conditions": {
                                "string": [
                                    {
                                        "value1": "={{ $json.intent }}",
                                        "value2": "conversation"
                                    }
                                ]
                            },
                            "renameOutput": true,
                            "outputKey": "conversation"
                        }
                    ]
                },
                "options": {
                    "fallbackOutput": "extra"
                }
            },
            "id": "router",
            "name": "Route by Intent",
            "type": "n8n-nodes-base.switch",
            "typeVersion": 1,
            "position": [
                850,
                300
            ]
        },
        {
            "parameters": {
                "content": "üéâ *Ho≈ü geldin MEGAPAZAR'a!*\\n\\nBen senin AI asistanƒ±nƒ±m. ≈ûunlarƒ± yapabilirim:\\n\\nüì¶ *ƒ∞lan Ver* - \"ilan vermek istiyorum\"\\nüîç *√úr√ºn Ara* - \"rotor arƒ±yorum\"\\nüìã *ƒ∞lanlarƒ±m* - \"ilanlarƒ±mƒ± g√∂ster\"\\nüìä *Sipari≈ülerim* - \"sipari≈ülerimi g√∂ster\"\\n‚ùì *Yardƒ±m* - \"yardƒ±m\"\\n\\nHemen ba≈ülamak i√ßin yukarƒ±daki komutlardan birini yazabilirsin!"
            },
            "id": "welcome-message",
            "name": "Send Welcome Message",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                1050,
                100
            ]
        },
        {
            "parameters": {
                "content": "üìö *MEGAPAZAR Yardƒ±m Men√ºs√º*\\n\\n*ƒ∞lan Verme:*\\n‚Ä¢ \"ilan vermek istiyorum\"\\n‚Ä¢ \"satmak istiyorum\"\\n\\n*√úr√ºn Arama:*\\n‚Ä¢ \"rotor arƒ±yorum\"\\n‚Ä¢ \"kompres√∂r bul\"\\n\\n*Listeleme:*\\n‚Ä¢ \"ilanlarƒ±mƒ± g√∂ster\"\\n‚Ä¢ \"sipari≈ülerimi g√∂ster\"\\n\\n*Diƒüer:*\\n‚Ä¢ \"yardƒ±m\" - Bu men√ºy√º g√∂ster\\n\\nSorularƒ±nƒ±z i√ßin doƒürudan mesaj atabilirsiniz! üí¨"
            },
            "id": "help-message",
            "name": "Send Help Menu",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                1050,
                200
            ]
        },
        {
            "parameters": {
                "url": "={{ $env.BACKEND_API_URL || 'https://your-backend-url.ngrok.io' }}/conversation",
                "method": "POST",
                "jsonParameters": true,
                "options": {},
                "bodyParametersJson": "={\n  \"user_id\": \"{{ $json.phoneNumber }}\",\n  \"message\": \"{{ $json.messageBody }}\",\n  \"source\": \"whatsapp\"\n}"
            },
            "id": "call-backend-conversation",
            "name": "Call Backend API - Conversation",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 1,
            "position": [
                1050,
                400
            ]
        },
        {
            "parameters": {
                "content": "={{ $json.response }}"
            },
            "id": "respond-conversation",
            "name": "Send API Response",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                1250,
                400
            ]
        },
        {
            "parameters": {
                "content": "üöÄ *Harika! ƒ∞lan vermeye ba≈ülayalƒ±m.*\\n\\nBana ≈üunlarƒ± s√∂yle:\\n1Ô∏è‚É£ Ne satƒ±yorsun?\\n2Ô∏è‚É£ Fiyatƒ± nedir?\\n3Ô∏è‚É£ √úr√ºn√ºn durumu (yeni/ikinci el)?\\n\\n√ñrnek: \"Rotor satƒ±yorum, 150 TL, ikinci el\""
            },
            "id": "start-listing",
            "name": "Start Listing Flow",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                1050,
                300
            ]
        },
        {
            "parameters": {
                "content": "üîç *Ne aramak istersin?*\\n\\n√ñrnek:\\n‚Ä¢ \"rotor arƒ±yorum\"\\n‚Ä¢ \"kompres√∂r 220V\"\\n‚Ä¢ \"500 TL'ye kadar soƒüutma cihazƒ±\""
            },
            "id": "start-search",
            "name": "Start Search Flow",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                1050,
                500
            ]
        },
        {
            "parameters": {
                "content": "‚ùå √úzg√ºn√ºm, ne demek istediƒüini anlayamadƒ±m.\\n\\n\"yardƒ±m\" yazarak komutlarƒ± g√∂rebilirsin."
            },
            "id": "fallback",
            "name": "Fallback Response",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                1050,
                600
            ]
        }
    ],
    "connections": {
        "WhatsApp Webhook": {
            "main": [
                [
                    {
                        "node": "Parse Incoming Message",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse Incoming Message": {
            "main": [
                [
                    {
                        "node": "Classify Intent",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Classify Intent": {
            "main": [
                [
                    {
                        "node": "Route by Intent",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Route by Intent": {
            "main": [
                [
                    {
                        "node": "Send Welcome Message",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Start Listing Flow",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Start Search Flow",
                        "type": "main",
                        "index": 0
                    }
                ],
                [],
                [
                    {
                        "node": "Send Help Menu",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Call Backend API - Conversation",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Fallback Response",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Call Backend API - Conversation": {
            "main": [
                [
                    {
                        "node": "Send API Response",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "settings": {
        "executionOrder": "v1"
    },
    "staticData": null,
    "tags": [],
    "triggerCount": 1,
    "updatedAt": "2025-01-17T00:00:00.000Z",
    "versionId": "1"
}